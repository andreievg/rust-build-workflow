name: check

on:
    workflow_call:
        inputs:
            os:
                required: true
                type: string

env:
    TEST_BINARIES: ${{ format('test_binaries_{0}', inputs.os) }}

jobs:
    check:
        runs-on: ${{ inputs.os }}
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Cache
              # Caches dependencies for rust (debug or test), does not cache increments
              uses: Swatinem/rust-cache@v1

              # Build and relocate test binaries to binary_files folder
            - name: Build Tests on Window
              if: runner.os == 'Windows'
              env:
                  OPENSSL_DIR: C:\Program Files\OpenSSL-Win64\
              run: |
                  choco install openssl
                  cargo build --tests --message-format=json | node workflow_helpers/relocate_build_binaries binary_files

              # Build and relocate test binaries to binary_files folder
            - name: Build Tests on Mac/Linux
              if: runner.os != 'Windows'
              run: |
                  cargo build --tests --message-format=json > build_info.txt
                  echo build_info.txt | node workflow_helpers/relocate_build_binaries binary_files
                  echo build_info.txt

            - name: Archive Tests
              uses: actions/upload-artifact@v3
              with:
                  name: ${{ env.TEST_BINARIES }}
                  path: binary_files
    check2:
        runs-on: ${{ inputs.os }}
        needs: check
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Download Test Binaries
              uses: actions/download-artifact@v3
              with:
                  name: ${{ env.TEST_BINARIES }}
                  path: binary_files

            - name: Make Binaries Executable
              # Permissions are lost during upload/download artifact
              if: runner.os != 'Windows'
              run: chmod +x binary_files/*

            # - name: Setup tmate session
            #   uses: mxschmitt/action-tmate@v3

            - name: Execute Test Binaries
              run: node workflow_helpers/execute_all_in_folder binary_files
